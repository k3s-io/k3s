name: Validate
on:
  pull_request:
    paths-ignore:
      - "**.md"
      - "channel.yaml"
      - "install.sh"
      - "tests/**"
      - "!tests/e2e**"
      - "!tests/docker**"
      - ".github/**"
      - "!.github/actions/**"
      - "!.github/workflows/validate.yaml"

permissions:
  contents: read

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Set Commit Count
        run: |
          echo "GITHUB_CHECKOUT_FETCH_DEPTH=$( expr 1 + ${{ github.event.pull_request.commits }} )" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: ${{ env.GITHUB_CHECKOUT_FETCH_DEPTH }}

      - name: Set Go Version
        run: |
          source ./scripts/version.sh
          echo "GOTOOLCHAIN=${VERSION_GOLANG/go}" >> "$GITHUB_ENV"

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "${{ env.GOTOOLCHAIN }}"

      - name: Lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.7
          args: "--new-from-merge-base ${{ github.event.pull_request.base.sha }}"

      - name: Lint (windows)
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.7
          args: "--new-from-merge-base ${{ github.event.pull_request.base.sha }} ./pkg/... ./cmd/..."
        env:
          GOOS: "windows"

      - name: Validate
        run: ./scripts/validate
        env:
          SKIP_LINT: "true"

      - name: Validate (windows)
        run: ./scripts/validate
        env:
          SKIP_LINT: "true"
          GOOS: "windows"
